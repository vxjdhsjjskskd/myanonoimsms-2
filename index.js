// –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram API
const TelegramBot = require('node-telegram-bot-api');

// –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –∏ ID –∞–¥–º–∏–Ω–∞ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
// –≠—Ç–æ –ª—É—á—à–∏–π —Å–ø–æ—Å–æ–± –¥–ª—è –¥–µ–ø–ª–æ—è –Ω–∞ Render/Heroku
const TOKEN = process.env.BOT_TOKEN;
const ADMIN_ID = process.env.ADMIN_ID;

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω—ã
if (!TOKEN || !ADMIN_ID) {
  console.error('–û—à–∏–±–∫–∞: –ù–µ –∑–∞–¥–∞–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è BOT_TOKEN –∏–ª–∏ ADMIN_ID!');
  process.exit(1);
}

// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
const bot = new TelegramBot(TOKEN, { polling: true });

// –≠—Ç–æ—Ç –æ–±—ä–µ–∫—Ç –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å, –∫–æ–º—É —Å–µ–π—á–∞—Å –æ—Ç–≤–µ—á–∞–µ—Ç –∞–¥–º–∏–Ω
const adminReplyState = {};

console.log('–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω...');
console.log(`ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: ${ADMIN_ID}`);


// --- –û–ë–†–ê–ë–û–¢–ö–ê –°–û–û–ë–©–ï–ù–ò–ô –û–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô ---

bot.on('message', (msg) => {
  const chatId = msg.chat.id;
  const messageId = msg.message_id;
  const userId = msg.from.id;
  const userName = msg.from.first_name || '';
  const userLastName = msg.from.last_name || '';
  const userUsername = msg.from.username ? `@${msg.from.username}` : '(–Ω–µ—Ç)';

  // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∞–¥–º–∏–Ω–∞, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –µ–≥–æ –∫–∞–∫ –æ—Ç–≤–µ—Ç
  if (String(userId) === String(ADMIN_ID)) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥ –¥–ª—è –æ—Ç–≤–µ—Ç–∞
    if (adminReplyState[ADMIN_ID]) {
      const targetUserId = adminReplyState[ADMIN_ID];
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç –∏–º–µ–Ω–∏ –±–æ—Ç–∞ (–∞–Ω–æ–Ω–∏–º–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
      bot.copyMessage(targetUserId, ADMIN_ID, messageId).then(() => {
        bot.sendMessage(ADMIN_ID, `‚úÖ –û—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${targetUserId}.`);
      }).catch(error => {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–∞:', error);
        bot.sendMessage(ADMIN_ID, `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç. –í–æ–∑–º–æ–∂–Ω–æ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞.`);
      });

      // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
      delete adminReplyState[ADMIN_ID];
    }
    return; // –ù–µ –ø–µ—Ä–µ—Å—ã–ª–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞ —Å–∞–º–æ–º—É —Å–µ–±–µ
  }

  // --- –ü–ï–†–ï–°–´–õ–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø –ê–î–ú–ò–ù–£ ---

  // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–¥–ø–∏—Å—å –∫ —Å–æ–æ–±—â–µ–Ω–∏—é
  const caption = `
–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!
<b>–û—Ç:</b> ${userName} ${userLastName}
<b>Username:</b> ${userUsername}
<b>ID:</b> <code>${userId}</code>
  `;

  // –°–æ–∑–¥–∞–µ–º –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫—É "–û—Ç–≤–µ—Ç–∏—Ç—å"
  const options = {
    // 'parse_mode' –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTML-—Ç–µ–≥–∏ –≤ —Ç–µ–∫—Å—Ç–µ
    parse_mode: 'HTML',
    reply_markup: {
      inline_keyboard: [
        [
          {
            text: '–û—Ç–≤–µ—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é',
            // –í callback_data –∑–∞—à–∏–≤–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ–±—ã –∑–Ω–∞—Ç—å, –∫–æ–º—É –æ—Ç–≤–µ—á–∞—Ç—å
            callback_data: `reply_to:${userId}`
          }
        ]
      ]
    }
  };
  
  // –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º –∫–æ–ø–∏—é —Å–æ–æ–±—â–µ–Ω–∏—è (–ª—é–±–æ–≥–æ —Ç–∏–ø–∞) –∞–¥–º–∏–Ω—É —Å –ø–æ–¥–ø–∏—Å—å—é –∏ –∫–Ω–æ–ø–∫–æ–π
  bot.forwardMessage(ADMIN_ID, chatId, messageId).then(() => {
    bot.sendMessage(ADMIN_ID, caption, options);
  }).catch(error => {
     console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Å—ã–ª–∫–µ:', error);
     bot.sendMessage(chatId, '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞. –ú—ã —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ–º –Ω–∞–¥ —ç—Ç–∏–º.');
  });
  
  // –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ
  bot.sendMessage(chatId, '–°–ø–∞—Å–∏–±–æ! –í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É. –û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞.');
});


// --- –û–ë–†–ê–ë–û–¢–ö–ê –ù–ê–ñ–ê–¢–ò–Ø –ù–ê –ò–ù–õ–ê–ô–ù-–ö–ù–û–ü–ö–£ ---

bot.on('callback_query', (callbackQuery) => {
  const data = callbackQuery.data;
  const adminId = callbackQuery.from.id;

  if (String(adminId) !== String(ADMIN_ID)) return; // –†–µ–∞–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞ –Ω–∞–∂–∞—Ç–∏—è –∞–¥–º–∏–Ω–∞

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–≤–µ—Ç
  if (data.startsWith('reply_to:')) {
    const userIdToReply = data.split(':')[1];
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º, –∫–∞–∫–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∞–¥–º–∏–Ω —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –æ—Ç–≤–µ—Ç–∏—Ç—å
    adminReplyState[ADMIN_ID] = userIdToReply;

    // –°–æ–æ–±—â–∞–µ–º –∞–¥–º–∏–Ω—É, —á—Ç–æ –±–æ—Ç –∂–¥–µ—Ç –µ–≥–æ —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    bot.sendMessage(ADMIN_ID, `üëá –¢–µ–ø–µ—Ä—å –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (—Ç–µ–∫—Å—Ç, —Ñ–æ—Ç–æ, —Å—Ç–∏–∫–µ—Ä, —á—Ç–æ —É–≥–æ–¥–Ω–æ), –∏ —è –ø–µ—Ä–µ—à–ª—é –µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å ID: <code>${userIdToReply}</code>.`, {parse_mode: 'HTML'});
    
    // –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å "—á–∞—Å–∏–∫–∏" –Ω–∞ –∫–Ω–æ–ø–∫–µ
    bot.answerCallbackQuery(callbackQuery.id);
  }
});
